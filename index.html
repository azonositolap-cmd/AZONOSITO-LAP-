<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<title>Azonosító lap</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
* { box-sizing: border-box; }

body {
  font-family: Arial, sans-serif;
  background: #f5f5f5;
  padding: 20px;
}

.container {
  background: #fff;
  max-width: 900px;
  margin: auto;
  padding: 30px;
  border: 1px solid #ccc;
}

h2 {
  text-align: center;
  margin-bottom: 30px;
}

.top-info {
  display: flex;
  justify-content: space-between;
  margin-bottom: 25px;
  font-weight: bold;
}

label {
  font-weight: bold;
  display: block;
  margin-top: 18px;
}

input, select, textarea, canvas {
  width: 100%;
  margin-top: 6px;
}

input, select, textarea {
  padding: 10px;
  font-size: 15px;
}

textarea {
  min-height: 90px;
  resize: vertical;
}

.row {
  display: flex;
  gap: 20px;
}

.row > div {
  flex: 1;
}

canvas {
  border: 1px solid #000;
  height: 150px;
  touch-action: none;
  background: #fff;
}

.checkbox {
  margin-top: 18px;
}

.checkbox label {
  font-weight: normal;
}

.checkbox input {
  transform: scale(1.2);
}

button {
  margin-top: 20px;
  padding: 14px;
  width: 100%;
  font-size: 16px;
  cursor: pointer;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body>

<!-- ⚠️ FONTOS: MINDEN BENNE VAN A DOC-BAN -->
<div class="container" id="doc">

<h2>Azonosító lap</h2>

<div class="top-info">
  <div>Dátum: <span id="datum"></span></div>
  <div>Érkeztetési szám: <span id="erkszam"></span></div>
</div>

<label>Megbízó neve</label>
<input type="text" id="gazdaNev">

<label>Cím</label>
<input type="text" id="cim">

<label>Telefonszám</label>
<input type="tel">

<label>Megbízott</label>
<input type="text" value="Budai Tamás e.v." readonly>

<label>Állat adatai</label>
<select id="allatFajta">
  <option value="">Válasszon</option>
  <option>Kutya</option>
  <option>Macska</option>
  <option>Egyéb</option>
</select>

<div id="egyebAllat" style="display:none;">
  <label>Milyen állat?</label>
  <input type="text">
</div>

<label>Megjegyzés</label>
<textarea></textarea>

<label>Megbízó aláírása</label>
<canvas id="signUser"></canvas>

<label>Ügyfél email címe</label>
<input type="email" id="ugyfelEmail" required>

<button id="pdfBtn">PDF készítés és küldés</button>

</div>

<script>
// ===== DÁTUM =====
const d = new Date();
const datumStr = d.toLocaleDateString("hu-HU");
document.getElementById("datum").innerText = datumStr;

// ===== ÉRKEZTETÉS =====
let c = localStorage.getItem("erk") || 0;
localStorage.setItem("erk", ++c);
document.getElementById("erkszam").innerText = `${d.getFullYear()}-${String(c).padStart(4,"0")}`;

// ===== ALÁÍRÁS =====
const canvas = document.getElementById("signUser");
const ctx = canvas.getContext("2d");
canvas.width = canvas.offsetWidth;
canvas.height = 150;
let draw = false;

canvas.addEventListener("mousedown", e => {
  draw = true;
  ctx.beginPath();
  ctx.moveTo(e.offsetX, e.offsetY);
});

canvas.addEventListener("mousemove", e => {
  if(!draw) return;
  ctx.lineTo(e.offsetX, e.offsetY);
  ctx.stroke();
});

["mouseup","mouseleave"].forEach(ev =>
  canvas.addEventListener(ev, () => draw = false)
);

// ===== FÁJLNÉV TISZTÍTÁS =====
function clean(str){
  return str.normalize("NFD")
    .replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-zA-Z0-9]+/g,"_")
    .replace(/^_|_$/g,"");
}

// ===== PDF + EMAIL =====
pdfBtn.onclick = async () => {
  if(!ugyfelEmail.value) {
    alert("Add meg az email címet!");
    return;
  }

  const gazda = clean(gazdaNev.value || "gazda");
  const cimClean = clean(cim.value || "cim");
  const datumClean = datumStr.replaceAll(".","-");

  const fileName = `azonosito_lap_${gazda}_${cimClean}_${datumClean}.pdf`;

  const pdfBlob = await html2pdf()
    .from(document.getElementById("doc"))
    .set({
      margin: 10,
      html2canvas: { scale: 1, scrollY: 0 },
      jsPDF: { unit: "mm", format: "a4" }
    })
    .outputPdf("blob");

  const fd = new FormData();
  fd.append("pdf", pdfBlob, fileName);
  fd.append("ugyfelEmail", ugyfelEmail.value);
  fd.append("gazdaNev", gazdaNev.value);
  fd.append("cim", cim.value);

  await fetch("/send-pdf", { method: "POST", body: fd });

  alert("PDF elküldve!");
};
</script>

</body>
</html>
